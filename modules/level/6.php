<?php
function escape($string) {
	$output = array();
	for ($i = 0, $length = strlen($string); $i < $length; ++$i) {
		$output[] = '\u00' . dechex(ord($string[$i]));
	}

	return implode('', $output);
}

list($usernamePos, $passwordPos) = explode('.', $tokenData['data'][$level - 1], 2);
list($usernamePos, ) = explode(',', $usernamePos, 2);
list($passwordPos, ) = explode(',', $passwordPos, 2);

if (isset($_POST['username'], $_POST['password'])) {
	$username = $_POST['username'];
	$password = $_POST['password'];

	if ($commonUsernames[$usernamePos] == $username && $commonPasswords[$passwordPos] == $password) {
		finishlevel($level);
	} else {
		$currentLevel['error'] = 'The username/password combination is incorrect.';
	}
}

$username = escape($commonUsernames[$usernamePos]);
$password = escape($commonPasswords[$passwordPos]);

$currentLevel['footer'] = <<< EOT
<script>
var p1 = '\u0066\u0075\u006e\u0063\u0074\u0069\u006f\u006e\u0020\u0063\u0028\u0029\u007b\u0076\u0061\u0072\u0020\u0061\u003d\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u0067\u0065\u0074\u0045\u006c\u0065\u006d\u0065\u006e\u0074\u0042\u0079\u0049\u0064\u0028\u0022\u0075\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u0022\u0029\u002c\u0062\u003d\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u0067\u0065\u0074\u0045\u006c\u0065\u006d\u0065\u006e\u0074\u0042\u0079\u0049\u0064\u0028\u0022\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0022\u0029\u003b\u0069\u0066\u0028\u0022\u0075\u006e\u0064\u0065\u0066\u0069\u006e\u0065\u0064\u0022\u0021\u003d\u0074\u0079\u0070\u0065\u006f\u0066\u0020\u0061\u0026\u0026\u0022\u0075\u006e\u0064\u0065\u0066\u0069\u006e\u0065\u0064\u0022\u0021\u003d\u0074\u0079\u0070\u0065\u006f\u0066\u0020\u0062\u0029\u007b\u0069\u0066\u0028\u0022{$username}';
var p2 = '{$password}\u0022\u003d\u003d\u0062\u002e\u0076\u0061\u006c\u0075\u0065\u0029\u0072\u0065\u0074\u0075\u0072\u006e\u0021\u0030\u003b\u0061\u006c\u0065\u0072\u0074\u0028\u0022\u0045\u0072\u0072\u006f\u0072\u003a\u0020\u0054\u0068\u0065\u0020\u0055\u0073\u0065\u0072\u006e\u0061\u006d\u0065\u002f\u0050\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u0020\u0063\u006f\u006d\u0062\u0069\u006e\u0061\u0074\u0069\u006f\u006e\u0020\u0069\u0073\u0020\u0069\u006e\u0063\u006f\u0072\u0072\u0065\u0063\u0074\u002e\u0022\u0029\u007d\u0072\u0065\u0074\u0075\u0072\u006e\u0021\u0031\u007d\u0076\u0061\u0072\u0020\u0064\u003d\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074\u002e\u0067\u0065\u0074\u0045\u006c\u0065\u006d\u0065\u006e\u0074\u0042\u0079\u0049\u0064\u0028\u0022\u0070\u0061\u0073\u0073\u0077\u006f\u0072\u0064\u002d\u0066\u006f\u0072\u006d\u0022\u0029\u003b\u0022\u0075\u006e\u0064\u0065\u0066\u0069\u006e\u0065\u0064\u0022\u0021\u003d\u0074\u0079\u0070\u0065\u006f\u0066\u0020\u0064\u0026\u0026\u0028\u0064\u002e\u006f\u006e\u0073\u0075\u0062\u006d\u0069\u0074\u003d\u0063\u0029\u003b';
eval(unescape(p1) + unescape('\u0022\u003d\u003d\u0061\u002e\u0076\u0061\u006c\u0075\u0065\u0026\u0026\u0022' + p2));
</script>
EOT;
